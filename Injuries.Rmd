---
title: "Injuries"
output: pdf_document
---

```{r, eval=TRUE}
library(rvest)
library(stringr)

counter=0

# Initialize data frame
injury_data <- data.frame(Season = character(), Date = character(), Round = numeric(), Team = character(), Opposition = character(), Out = character(), Reason = character(), HA = character())

for (h in 2:9){
  # Go to Wikepedia page for each AFL season
	season_data <- read_html(paste0('https://en.wikipedia.org/wiki/201', h, '_AFL_season'))
	# Pull URLs linking to every individual game in a season
	pointer <- season_data %>%
		html_nodes('.text') %>%
		as.matrix(html_text()) %>%
		xml_attr("href")

	pointer <- as.matrix(pointer)
	n=nrow(pointer)

	urls <- data.frame(link = character())

	names(urls) <- c("Link")

	for (i in 1:n){
	  # For URLs that are actually games, put them into dataset entitled "urls"
		if (str_detect(pointer[i], "match-centre")=="TRUE"){
			newrow <- data.frame(Link=pointer[i])
			urls <- rbind(urls, newrow)
		}
	}
	urls <- as.matrix(urls)
	x <- c("Link")
	colnames(urls) <- x

	n=nrow(urls)

	# Go through "urls" to pull injuries from every game
	for (i in 1:n){
	  # Fix inconsistencies on AFL site's URLs
		if (urls[i] == "http://www.afl.com.au/match-centre/2012/3/nmfc-v-gee"){
			urls[i] <- "http://www.afl.com.au/match-centre/2012/3/nmfc-v-geel"
		}
		if (urls[i] == "http://www.afl.com.au/match-centre/2018/21/mel-v-syd"){
		urls[i] <- "http://www.afl.com.au/match-centre/2018/21/melb-v-syd"
		}
	  
	  if (urls[i] == "http://www.afl.com.au/match-centre/2012/13/coll-v-wce" || urls[i]== "http://www.afl.com.au/match-centre/2012/22/stk-v-gws"){
	    url <- read_html(urls[i])
	    round <- url %>%
	      html_nodes('.o-mc-banner__inner--left .o-mc-banner__supplementary-text:nth-child(1)') %>%
	      as.matrix(html_text())
	    n=nrow(round)
	    round <- round[n]
	    round <- gsub('<span>', "", round)
	    round <- gsub('</span>', "", round)
	    round <- gsub('Round ', "", round)
	    date <- url %>%
	      html_nodes('.o-mc-banner__inner--left .o-mc-banner__supplementary-text:nth-child(1)') %>%
	      html_text()
	    date <- strsplit(date, " ")
	    date <- matrix(unlist(date))
	    date <- date[39:41]
	    date <- gsub('</li>', "", date)
	    season <- date[3]
	    date[1] <- gsub('\\d', "", date[1])
	    date <- gsub(':\\sA..T,\\s', "", date)
	    date <- paste(date[1], date[2], date[3])
	    teams <- url %>%
	      html_nodes('title') %>%
	      html_text()
	    teams <- strsplit(teams, "Vs")
	    teams <- matrix(unlist(teams))
	    teams <- strsplit(teams, "-")
	    teams <- matrix(unlist(teams))
	    teams <- trimws(teams)
	    team1 <- teams[1]
	    team2 <- teams[2]
	    opposition1 <- teams[2]
	    opposition2 <- teams[1]
	  }
	  else{
	    url <- read_html(urls[i])
  	  round <- url %>%
  	    html_nodes('.match-details span') %>%
  	    as.matrix(html_text())
  	  n=nrow(round)
  	  round <- round[n]
  	  round <- gsub('<span>', "", round)
  	  round <- gsub('</span>', "", round)
  	  round <- gsub('Round ', "", round)
  	  if (round == "Finals Week 1"){
  	    date <- url %>%
  	      html_nodes('.match-details li+ li') %>%
  	      html_text()
  	    date <- strsplit(date, " ")
  	    date <- matrix(unlist(date))
  	    date <- date[39:41]
  	    date <- gsub('</li>', "", date)
  	    season <- date[3]
  	    date[1] <- gsub('\\d', "", date[1])
  	    date <- gsub(':\\sA..T,\\s', "", date)
  	    date <- paste(date[1], date[2], date[3])
  	  }
  	  else{
  	    date <- url %>%
  	      html_nodes('.match-details li+ li') %>%
  	      as.matrix(html_text())	
  	    date <- as.character(date)
  	    date <- strsplit(date, " ")
  	    date <- matrix(unlist(date))
  	    date <- date[38:40]
  	    date <- gsub('</li>', "", date)
  	    season <- date[3]
  	    date[1] <- gsub('\\d', "", date[1])
  	    date <- gsub(':\\sA..T,\\s', "", date)
  	    date <- paste(date[1], date[2], date[3])
  	  }
  	  teams <- url %>%
  	    html_nodes('.match-details li:nth-child(1)') %>%
  	    as.matrix(html_text())	
  	  teams <- gsub("<li>", "", teams)
  	  teams <- gsub("</li>", "", teams)
  	  teams <- strsplit(teams, "v")
  	  teams <- matrix(unlist(teams))
  	  teams <- trimws(teams)
  	  team1 <- teams[1]
  	  team2 <- teams[2]
  	  opposition1 <- teams[2]
  	  opposition2 <- teams[1]
	  }
		
		injuries <- url %>%
			html_nodes('.out ul') %>%
			as.matrix(html_text())
			if (exists("injuries") == "FALSE"){
				next
			}
		injuries <- gsub('<li class="last">', "", injuries)
		injuries <- gsub('</li>', "", injuries)
		injuries <- matrix(unlist(injuries))
		injuries <- strsplit(injuries, "\n\t\t")
		
		injuries1 <- injuries[1]
		injuries2 <- injuries[2]
		
		if (injuries2 == "NULL"){
		  injuries2 <- injuries1
		}
		
		if (injuries1 != "NULL"){
			injuries1 <- matrix(unlist(injuries1))
			injuries1 <- trimws(injuries1)
			injuries1 <- injuries1[seq(2, nrow(injuries1), 2)]
			injuries1 <- matrix(injuries1)
			injuries1 <- gsub(',', "", injuries1)
			reason1 <- injuries1
			injuries1 <- gsub("\\s*\\([^0\\)]+\\)", "", injuries1)
			injuries1 <- matrix(injuries1)
			reason1 <- gsub("^.*\\s", "", reason1)
			reason1 <- gsub("[\\(+\\)]", "", reason1)
			for (j in 1:nrow(injuries1)){
				newrow <- data.frame(Season = season, Date = date, Round = round, Team = team1, Opposition = opposition1, Out = injuries1[j], Reason = reason1[j], HA = "Home")
				injury_data <- rbind(injury_data, newrow)	
			}
		}

		if (injuries2 != "NULL"){
			injuries2 <- matrix(unlist(injuries2))
			injuries2 <- trimws(injuries2)
			injuries2 <- injuries2[seq(2, nrow(injuries2), 2)]
			injuries2 <- matrix(injuries2)
			injuries2 <- gsub(',', "", injuries2)
			reason2 <- injuries2
			injuries2 <- gsub("\\s*\\([^0\\)]+\\)", "", injuries2)
			injuries2 <- matrix(injuries2)
			reason2 <- gsub("^.*\\s", "", reason2)
			reason2 <- gsub("[\\(+\\)]", "", reason2)
			for (j in 1:nrow(injuries2)){
				newrow <- data.frame(Season = season, Date = date, Round = round, Team = team2, Opposition = opposition2, Out = injuries2[j], Reason = reason2[j], HA = "Away")
				injury_data <- rbind(injury_data, newrow)	
			}
		}
		counter = counter + 1
		print(counter)
	}

	rm(season_data, pointer, urls, newrow, x, n, url, date, season, round, team1, team2, opposition1, opposition2, injuries, injuries1, injuries2, reason1, reason2)

}

names(injury_data) <- c("Season", "Date", "Round", "Team", "Opposition", "Out", "Reason")

injury_data <- unique(injury_data)

write.csv(injury_data, "injuries_2012-2019.csv")
```